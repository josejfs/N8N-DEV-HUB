#!/bin/bash
# N8N-DevHub - Inicializador do Ambiente de Desenvolvimento

set -e

# Ir para diretÃ³rio raiz do projeto (2 nÃ­veis acima)
cd "$(dirname "$0")/../.."

echo "ğŸš€ Inicializando Ambiente de Desenvolvimento N8N-DevHub..."
echo

# Verificar se Python estÃ¡ disponÃ­vel
if ! command -v python3 &> /dev/null; then
    echo "âŒ Python3 nÃ£o encontrado. Instale Python 3.8+ primeiro."
    exit 1
fi

# Verificar se Docker estÃ¡ rodando
if ! docker info > /dev/null 2>&1; then
    echo "âŒ Docker nÃ£o estÃ¡ rodando. Inicie o Docker primeiro."
    exit 1
fi

# Criar ambiente virtual Python se nÃ£o existir
if [ ! -d "venv" ]; then
    echo "ğŸ Criando ambiente virtual Python..."
    python3 -m venv venv
    echo "âœ… Ambiente virtual criado"
else
    echo "âœ… Ambiente virtual jÃ¡ existe"
fi

# Ativar ambiente virtual
echo "ğŸ“¦ Ativando ambiente virtual..."
source venv/bin/activate

# Instalar/atualizar dependÃªncias
echo "ğŸ“š Instalando dependÃªncias Python..."
pip install --upgrade pip > /dev/null 2>&1
pip install -r N8N-DevHub/requirements.txt

echo "âœ… DependÃªncias Python instaladas"
echo

# Criar pasta workflows se nÃ£o existir
if [ ! -d "workflows" ]; then
    echo "ğŸ“ Criando pasta workflows..."
    mkdir -p workflows
    echo "âœ… Pasta workflows criada"
else
    echo "âœ… Pasta workflows jÃ¡ existe"
fi
echo

# Ir para diretÃ³rio N8N-DevHub para executar docker-compose
cd "N8N-DevHub"

# Verificar se docker-compose existe
if [ ! -f "docker-compose.yml" ]; then
    echo "âŒ docker-compose.yml nÃ£o encontrado em N8N-DevHub/"
    exit 1
fi

echo "ğŸ“‹ ConfiguraÃ§Ãµes do ambiente:"
echo "   â€¢ N8N: http://localhost:5678"
echo "   â€¢ User: admin"
echo "   â€¢ Pass: admin123"
echo "   â€¢ Timezone: America/Sao_Paulo"
echo "   â€¢ Database: SQLite (volume nomeado)"
echo "   â€¢ Workflows: ../workflows"
echo

# Iniciar containers
echo "ğŸ³ Iniciando containers Docker..."
docker-compose up -d

# Aguardar n8n ficar disponÃ­vel
echo "â³ Aguardando n8n ficar disponÃ­vel..."
timeout=60
counter=0

while ! curl -s http://localhost:5678 > /dev/null; do
    if [ $counter -ge $timeout ]; then
        echo "âŒ Timeout: N8N nÃ£o respondeu em ${timeout}s"
        exit 1
    fi
    
    echo -n "."
    sleep 1
    counter=$((counter + 1))
done

echo
echo "âœ… N8N estÃ¡ rodando!"
echo
echo "ğŸŒ Acesse: http://localhost:5678"
echo "ğŸ‘¤ Login: admin / admin123"
echo
echo "ğŸ“‹ Comandos Ãºteis:"
echo "   ./devhub list                    # Listar workflows"
echo "   ./devhub sync-start 'workflow'   # Iniciar sincronizaÃ§Ã£o"
echo "   docker-compose -f N8N-DevHub/docker-compose.yml logs -f  # Ver logs"
echo "   docker-compose -f N8N-DevHub/docker-compose.yml down     # Parar"
echo

# Voltar para diretÃ³rio raiz
cd ..

# Testar conexÃ£o com DevHub (com venv ativo)
echo "ğŸ” Testando conexÃ£o DevHub..."
if python3 N8N-DevHub/python/devhub.py list > /dev/null 2>&1; then
    echo "âœ… DevHub conectado com sucesso!"
else
    echo "âš ï¸  DevHub com problema de conexÃ£o (normal na primeira vez)"
fi

echo
echo "ğŸ‰ Ambiente de desenvolvimento inicializado!"
echo ""
echo "ğŸ“‹ Para usar o DevHub:"
echo "   source venv/bin/activate  # Ativar ambiente virtual"
echo "   ./devhub list             # Ou usar diretamente"
echo ""
echo "ğŸš€ Comece desenvolvendo seus workflows!"