#!/bin/bash
# N8N-DevHub - Instalação Global
# Torna o comando 'devhub' disponível globalmente no sistema

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Função para print colorido
print_step() {
    echo -e "${CYAN}[INSTALAÇÃO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}✅ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠️  $1${NC}"
}

print_error() {
    echo -e "${RED}❌ $1${NC}"
}

# Obter diretório do projeto
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$(dirname "$PROJECT_DIR")"

print_step "Iniciando instalação global do N8N-DevHub..."
echo "📁 Projeto detectado em: $PROJECT_DIR"
echo

# Verificar se o projeto está no local correto
if [ ! -f "$PROJECT_DIR/devhub" ]; then
    print_error "Script devhub não encontrado em $PROJECT_DIR"
    exit 1
fi

# Criar diretório ~/.local/bin se não existir
print_step "Criando diretório ~/.local/bin..."
mkdir -p ~/.local/bin
print_success "Diretório criado"

# Criar script global com caminhos absolutos
print_step "Criando script global em ~/.local/bin/devhub..."

cat > ~/.local/bin/devhub << EOF
#!/bin/bash
# N8N-DevHub - Script Principal (Global)
# Instalado automaticamente em $(date)

# Diretório do projeto N8N (configurado durante instalação)
PROJECT_DIR="$PROJECT_DIR"
DEVHUB_DIR="\$PROJECT_DIR/N8N-DevHub"

# Verificar se projeto ainda existe
if [ ! -d "\$PROJECT_DIR" ]; then
    echo "❌ Projeto N8N-DevHub não encontrado em \$PROJECT_DIR"
    echo "💡 Execute novamente o script de instalação global:"
    echo "   \$PROJECT_DIR/N8N-DevHub/scripts/install-global"
    exit 1
fi

# Comandos especiais
case "\$1" in
    "init")
        echo "🚀 Inicializando N8N-DevHub..."
        cd "\$PROJECT_DIR"
        exec "\$DEVHUB_DIR/scripts/init-dev"
        ;;
    "docker")
        shift
        cd "\$PROJECT_DIR"
        exec "\$DEVHUB_DIR/scripts/dev-control" "\$@"
        ;;
    "install-global")
        echo "🔧 Reinstalando devhub globalmente..."
        exec "\$DEVHUB_DIR/scripts/install-global"
        ;;
    *)
        # Detectar se precisa ativar venv
        if [ -d "\$PROJECT_DIR/venv" ] && [ -z "\$VIRTUAL_ENV" ]; then
            source "\$PROJECT_DIR/venv/bin/activate"
        fi
        
        # Mudar para diretório do projeto
        cd "\$PROJECT_DIR"
        
        # Executar DevHub Python
        exec python3 "\$DEVHUB_DIR/python/devhub.py" "\$@"
        ;;
esac
EOF

chmod +x ~/.local/bin/devhub
print_success "Script global criado e executável"

# Verificar se ~/.local/bin está no PATH
print_step "Verificando configuração do PATH..."

if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    print_warning "~/.local/bin não está no PATH"
    
    # Adicionar ao .bashrc se não estiver lá
    if ! grep -q 'export PATH="$HOME/.local/bin:$PATH"' ~/.bashrc 2>/dev/null; then
        print_step "Adicionando ~/.local/bin ao PATH em ~/.bashrc..."
        echo '' >> ~/.bashrc
        echo '# N8N-DevHub - PATH para comandos globais' >> ~/.bashrc
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
        print_success "PATH configurado em ~/.bashrc"
    fi
    
    # Configurar para sessão atual
    export PATH="$HOME/.local/bin:$PATH"
    print_success "PATH configurado para sessão atual"
else
    print_success "~/.local/bin já está no PATH"
fi

# Testar instalação
print_step "Testando instalação..."

if command -v devhub >/dev/null 2>&1; then
    print_success "Comando 'devhub' disponível globalmente!"
    echo
    echo -e "${CYAN}🎉 INSTALAÇÃO CONCLUÍDA!${NC}"
    echo
    echo "Agora você pode usar 'devhub' de qualquer diretório:"
    echo -e "  ${GREEN}devhub help${NC}              # Ver ajuda"
    echo -e "  ${GREEN}devhub list${NC}              # Listar workflows"
    echo -e "  ${GREEN}devhub download \"Demo\"${NC}    # Baixar workflow"
    echo -e "  ${GREEN}devhub sync-start \"Demo\"${NC}  # Iniciar sync"
    echo
    echo -e "${YELLOW}💡 Dica:${NC} Se o comando não funcionar em um novo terminal,"
    echo "   execute: source ~/.bashrc"
    
else
    print_error "Falha na instalação - comando não encontrado"
    echo
    echo "Para usar manualmente:"
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    echo "  devhub help"
    exit 1
fi

# Verificar se pode executar um comando de teste
echo
print_step "Teste final de conectividade..."
if devhub list >/dev/null 2>&1; then
    print_success "DevHub funcionando corretamente!"
else
    print_warning "DevHub instalado mas pode ter problemas de conectividade"
    echo "Verifique se o N8N está rodando: devhub docker start"
fi

echo
print_success "Instalação global concluída com sucesso! 🚀"