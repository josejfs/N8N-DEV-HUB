#!/bin/bash
# N8N-DevHub - InstalaÃ§Ã£o Global
# Torna o comando 'devhub' disponÃ­vel globalmente no sistema

set -e

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# FunÃ§Ã£o para print colorido
print_step() {
    echo -e "${CYAN}[INSTALAÃ‡ÃƒO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}âœ… $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}âš ï¸  $1${NC}"
}

print_error() {
    echo -e "${RED}âŒ $1${NC}"
}

# Obter diretÃ³rio do projeto
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
PROJECT_DIR="$(dirname "$PROJECT_DIR")"

print_step "Iniciando instalaÃ§Ã£o global do N8N-DevHub..."
echo "ğŸ“ Projeto detectado em: $PROJECT_DIR"
echo

# Verificar se o projeto estÃ¡ no local correto
if [ ! -f "$PROJECT_DIR/devhub" ]; then
    print_error "Script devhub nÃ£o encontrado em $PROJECT_DIR"
    exit 1
fi

# Criar diretÃ³rio ~/.local/bin se nÃ£o existir
print_step "Criando diretÃ³rio ~/.local/bin..."
mkdir -p ~/.local/bin
print_success "DiretÃ³rio criado"

# Criar script global com caminhos absolutos
print_step "Criando script global em ~/.local/bin/devhub..."

cat > ~/.local/bin/devhub << EOF
#!/bin/bash
# N8N-DevHub - Script Principal (Global)
# Instalado automaticamente em $(date)

# DiretÃ³rio do projeto N8N (configurado durante instalaÃ§Ã£o)
PROJECT_DIR="$PROJECT_DIR"
DEVHUB_DIR="\$PROJECT_DIR/N8N-DevHub"

# Verificar se projeto ainda existe
if [ ! -d "\$PROJECT_DIR" ]; then
    echo "âŒ Projeto N8N-DevHub nÃ£o encontrado em \$PROJECT_DIR"
    echo "ğŸ’¡ Execute novamente o script de instalaÃ§Ã£o global:"
    echo "   \$PROJECT_DIR/N8N-DevHub/scripts/install-global"
    exit 1
fi

# Comandos especiais
case "\$1" in
    "init")
        echo "ğŸš€ Inicializando N8N-DevHub..."
        cd "\$PROJECT_DIR"
        exec "\$DEVHUB_DIR/scripts/init-dev"
        ;;
    "docker")
        shift
        cd "\$PROJECT_DIR"
        exec "\$DEVHUB_DIR/scripts/dev-control" "\$@"
        ;;
    "install-global")
        echo "ğŸ”§ Reinstalando devhub globalmente..."
        exec "\$DEVHUB_DIR/scripts/install-global"
        ;;
    *)
        # Detectar se precisa ativar venv
        if [ -d "\$PROJECT_DIR/venv" ] && [ -z "\$VIRTUAL_ENV" ]; then
            source "\$PROJECT_DIR/venv/bin/activate"
        fi
        
        # Mudar para diretÃ³rio do projeto
        cd "\$PROJECT_DIR"
        
        # Executar DevHub Python
        exec python3 "\$DEVHUB_DIR/python/devhub.py" "\$@"
        ;;
esac
EOF

chmod +x ~/.local/bin/devhub
print_success "Script global criado e executÃ¡vel"

# Verificar se ~/.local/bin estÃ¡ no PATH
print_step "Verificando configuraÃ§Ã£o do PATH..."

if [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
    print_warning "~/.local/bin nÃ£o estÃ¡ no PATH"
    
    # Adicionar ao .bashrc se nÃ£o estiver lÃ¡
    if ! grep -q 'export PATH="$HOME/.local/bin:$PATH"' ~/.bashrc 2>/dev/null; then
        print_step "Adicionando ~/.local/bin ao PATH em ~/.bashrc..."
        echo '' >> ~/.bashrc
        echo '# N8N-DevHub - PATH para comandos globais' >> ~/.bashrc
        echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
        print_success "PATH configurado em ~/.bashrc"
    fi
    
    # Configurar para sessÃ£o atual
    export PATH="$HOME/.local/bin:$PATH"
    print_success "PATH configurado para sessÃ£o atual"
else
    print_success "~/.local/bin jÃ¡ estÃ¡ no PATH"
fi

# Testar instalaÃ§Ã£o
print_step "Testando instalaÃ§Ã£o..."

if command -v devhub >/dev/null 2>&1; then
    print_success "Comando 'devhub' disponÃ­vel globalmente!"
    echo
    echo -e "${CYAN}ğŸ‰ INSTALAÃ‡ÃƒO CONCLUÃDA!${NC}"
    echo
    echo "Agora vocÃª pode usar 'devhub' de qualquer diretÃ³rio:"
    echo -e "  ${GREEN}devhub help${NC}              # Ver ajuda"
    echo -e "  ${GREEN}devhub list${NC}              # Listar workflows"
    echo -e "  ${GREEN}devhub download \"Demo\"${NC}    # Baixar workflow"
    echo -e "  ${GREEN}devhub sync-start \"Demo\"${NC}  # Iniciar sync"
    echo
    echo -e "${YELLOW}ğŸ’¡ Dica:${NC} Se o comando nÃ£o funcionar em um novo terminal,"
    echo "   execute: source ~/.bashrc"
    
else
    print_error "Falha na instalaÃ§Ã£o - comando nÃ£o encontrado"
    echo
    echo "Para usar manualmente:"
    echo "  export PATH=\"\$HOME/.local/bin:\$PATH\""
    echo "  devhub help"
    exit 1
fi

# Verificar se pode executar um comando de teste
echo
print_step "Teste final de conectividade..."
if devhub list >/dev/null 2>&1; then
    print_success "DevHub funcionando corretamente!"
else
    print_warning "DevHub instalado mas pode ter problemas de conectividade"
    echo "Verifique se o N8N estÃ¡ rodando: devhub docker start"
fi

echo
print_success "InstalaÃ§Ã£o global concluÃ­da com sucesso! ğŸš€"